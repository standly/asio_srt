# ä»£ç å®¡æŸ¥æ€»ç»“

æœ¬æ–‡æ¡£æ€»ç»“äº†é’ˆå¯¹ acore åº“è¿›è¡Œçš„ä¸‰è½® Linus é£æ ¼ä»£ç å®¡æŸ¥åŠç›¸åº”çš„æ”¹è¿›ã€‚

## ç¬¬ä¸€è½®å®¡æŸ¥ï¼šæ ¸å¿ƒè®¾è®¡é—®é¢˜

### å‘ç°çš„é—®é¢˜
1. **async_waitgroup.hpp**: atomic + strand æ··ç”¨ï¼Œè®¾è®¡æ··ä¹±
2. **async_queue.hpp**: åŒ strand è®¾è®¡å¯¼è‡´æ€§èƒ½é—®é¢˜
3. **æ•´ä½“**: atomic ä½¿ç”¨ç­–ç•¥ä¸ä¸€è‡´

### å®æ–½çš„æ”¹è¿›

#### 1. async_waitgroup.hpp
- âœ… **ç§»é™¤ atomic count_**ï¼šæ”¹ä¸ºå®Œå…¨ç”± strand ä¿æŠ¤çš„æ™®é€šå˜é‡
- âœ… **add() å’Œ done() æ”¹ä¸ºå¼‚æ­¥**ï¼šç¬¦åˆå¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼Œæ¶ˆé™¤å¤æ‚çš„åŒé‡æ£€æŸ¥é€»è¾‘
- âœ… **ç§»é™¤ reset() å’Œ close() æ–¹æ³•**ï¼šä¿æŒ WaitGroup çš„æ ¸å¿ƒè¯­ä¹‰ï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
- âœ… **count() æ”¹ä¸º async_count()**ï¼šé¿å…ç»™ç”¨æˆ·è™šå‡çš„çº¿ç¨‹å®‰å…¨æ„Ÿ

**æ”¹è¿›å‰**ï¼š
```cpp
std::atomic<int64_t> count_{0};
void add(int64_t delta) {
    // åŒæ­¥æ›´æ–° + å¼‚æ­¥å”¤é†’ + åŒé‡æ£€æŸ¥
    int64_t old_count = count_.fetch_add(delta, std::memory_order_acq_rel);
    // ...å¤æ‚çš„ç«æ€å¤„ç†
}
```

**æ”¹è¿›å**ï¼š
```cpp
int64_t count_{0};  // ä»…åœ¨ strand å†…è®¿é—®
void add(int64_t delta) {
    asio::post(strand_, [this, self = shared_from_this(), delta]() {
        count_ += delta;
        if (count_ == 0) {
            notify_all_waiters();
        }
    });
}
```

#### 2. async_semaphore.hpp
- âœ… **æ·»åŠ å¯é€‰çš„ strand å‚æ•°**ï¼šæ”¯æŒå¤–éƒ¨æä¾› strandï¼Œç”¨äºæ€§èƒ½ä¼˜åŒ–
- âœ… **ä¿ç•™å†…éƒ¨ strand ç‰ˆæœ¬**ï¼šä¿æŒå‘åå…¼å®¹å’Œç‹¬ç«‹ä½¿ç”¨åœºæ™¯

**æ–°å¢æ„é€ å‡½æ•°**ï¼š
```cpp
// ä½¿ç”¨å¤–éƒ¨ strandï¼ˆé«˜æ€§èƒ½ï¼‰
explicit async_semaphore(asio::strand<executor_type> strand, size_t initial_count = 0);
```

#### 3. async_queue.hpp
- âœ… **ä½¿ç”¨å…±äº« strand**ï¼šqueue å’Œ semaphore å…±äº«åŒä¸€ä¸ª strand
- âœ… **æ¶ˆé™¤è·¨ strand å¼€é”€**ï¼šsemaphore å›è°ƒç›´æ¥è®¿é—®é˜Ÿåˆ—ï¼Œæ— éœ€é¢å¤– post
- âœ… **æ€§èƒ½æå‡**ï¼šå‡å°‘ä¸€æ¬¡å¼‚æ­¥è°ƒåº¦å»¶è¿Ÿ

**æ”¹è¿›å‰**ï¼š
```cpp
async_semaphore semaphore_(io_context.get_executor(), 0);  // ç‹¬ç«‹ strand
// æ¯æ¬¡è¯»å–éœ€è¦åœ¨ä¸¤ä¸ª strand é—´åˆ‡æ¢
```

**æ”¹è¿›å**ï¼š
```cpp
async_semaphore semaphore_(strand_, 0);  // å…±äº« strand
// å›è°ƒç›´æ¥åœ¨åŒä¸€ä¸ª strand ä¸Šæ‰§è¡Œ
```

---

## ç¬¬äºŒè½®å®¡æŸ¥ï¼šè®¾è®¡ç»†èŠ‚å’Œæ–‡æ¡£

### å‘ç°çš„é—®é¢˜
1. **async_semaphore.hpp**: owns_strand_ å­—æ®µæ— ç”¨
2. **æ‰€æœ‰ç±»**: ç¼ºå°‘æ˜¾å¼åˆ é™¤çš„æ‹·è´/ç§»åŠ¨æ„é€ å‡½æ•°
3. **async_queue.hpp**: handler æ‰§è¡Œä¸Šä¸‹æ–‡æ–‡æ¡£ä¸æ¸…æ™°
4. **handler_traits.hpp**: cancellable_void_handler_base çš„é€»è¾‘éœ€è¦æ˜ç¡®

### å®æ–½çš„æ”¹è¿›

#### 1. åˆ é™¤æ— ç”¨æˆå‘˜
- âœ… **ç§»é™¤ owns_strand_**ï¼šä¸å½±å“è¡Œä¸ºçš„å­—æ®µè¢«åˆ é™¤

#### 2. æ˜¾å¼åˆ é™¤æ‹·è´å’Œç§»åŠ¨
ä¸ºæ‰€æœ‰ä½¿ç”¨ `enable_shared_from_this` çš„ç±»æ·»åŠ ï¼š
```cpp
// ç¦æ­¢æ‹·è´å’Œç§»åŠ¨ï¼ˆè®¾è®¡ä¸Šé€šè¿‡ shared_ptr ä½¿ç”¨ï¼‰
async_waitgroup(const async_waitgroup&) = delete;
async_waitgroup& operator=(const async_waitgroup&) = delete;
async_waitgroup(async_waitgroup&&) = delete;
async_waitgroup& operator=(async_waitgroup&&) = delete;
```

åº”ç”¨åˆ°ï¼š
- âœ… async_waitgroup
- âœ… async_semaphore
- âœ… async_queue
- âœ… async_event
- âœ… dispatcher

#### 3. æ”¹è¿›æ–‡æ¡£

**async_count() çš„è®¾è®¡è¯´æ˜**ï¼š
```cpp
/**
 * @brief å¼‚æ­¥è·å–å½“å‰è®¡æ•°
 * 
 * è®¾è®¡è¯´æ˜ï¼š
 * - ä½¿ç”¨å¼‚æ­¥æ¥å£è€ŒéåŒæ­¥çš„ count() æ–¹æ³•
 * - åŸå› ï¼šåŒæ­¥æ–¹æ³•è¿”å›çš„å€¼å¯èƒ½åœ¨ä¸‹ä¸€æ—¶åˆ»å°±å¤±æ•ˆï¼ˆç«æ€æ¡ä»¶ï¼‰
 * - å¼‚æ­¥æ¥å£å¼ºåˆ¶ç”¨æˆ·æ„è¯†åˆ°è¿™æ˜¯ä¸€ä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§ï¼Œä»…åœ¨å›è°ƒæ—¶åˆ»æœ‰æ•ˆ
 * - è¿™é¿å…äº†ç»™ç”¨æˆ·è™šå‡çš„çº¿ç¨‹å®‰å…¨æ„Ÿ
 */
```

**handler æ‰§è¡Œä¸Šä¸‹æ–‡è­¦å‘Š**ï¼š
```cpp
/**
 * é‡è¦ï¼šcompletion handler åœ¨å†…éƒ¨ strand ä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨è°ƒç”¨è€…çš„ executor ä¸Šã€‚
 * å¦‚æœä½ éœ€è¦åœ¨ç‰¹å®šçš„ executorï¼ˆå¦‚åç¨‹çš„ strandï¼‰ä¸Šæ‰§è¡Œï¼Œè¯·åœ¨ handler ä¸­
 * ä½¿ç”¨ asio::post åˆ‡æ¢åˆ°ç›®æ ‡ executorã€‚
 */
```

#### 4. æ”¹è¿› handler_traits.hpp
```cpp
void invoke() {
    // æ³¨æ„ï¼šå¦‚æœå·²å–æ¶ˆï¼ˆinner_ ä¸ºç©ºï¼‰ï¼Œä¸æ‰§è¡Œ
    // è¿™æ˜¯åˆæ³•çš„ï¼šcancel() åçš„ invoke() è°ƒç”¨ä¼šè¢«é™é»˜å¿½ç•¥
    if (inner_) {
        inner_->invoke();
    }
}
```

---

## ç¬¬ä¸‰è½®å®¡æŸ¥ï¼šæ€§èƒ½å’Œæœ€ä½³å®è·µ

### å‘ç°çš„é—®é¢˜
1. **async_queue.hpp**: æˆå‘˜å£°æ˜é¡ºåºä¸åˆå§‹åŒ–é¡ºåºä¸ä¸€è‡´
2. **ç¤ºä¾‹ä»£ç **: æ•è·è¯­ä¹‰ä¸æ˜¯æœ€ä½³å®è·µ
3. **æ–‡æ¡£**: ç¼ºå°‘æ€§èƒ½æŒ‡å—

### å®æ–½çš„æ”¹è¿›

#### 1. ä¿®å¤æˆå‘˜å£°æ˜é¡ºåº
ç¡®ä¿ `strand_` åœ¨ `semaphore_` ä¹‹å‰å£°æ˜ï¼š

**æ”¹è¿›å‰**ï¼š
```cpp
asio::strand<asio::any_io_executor> strand_;
async_semaphore semaphore_;
std::deque<T> queue_;
```

**æ”¹è¿›å**ï¼š
```cpp
asio::strand<asio::any_io_executor> strand_;  // å¿…é¡»åœ¨ semaphore_ ä¹‹å‰å£°æ˜
std::deque<T> queue_;
bool stopped_;
async_semaphore semaphore_;  // æœ€ååˆå§‹åŒ–
```

#### 2. æ”¹è¿›ç¤ºä¾‹ä»£ç 
**æ”¹è¿›å‰**ï¼š
```cpp
asio::post(my_strand, [ec, msg = std::move(msg)]() {
    process(msg);  // msg å·²ç» move äº†
});
```

**æ”¹è¿›å**ï¼š
```cpp
asio::post(my_strand, [ec, msg = std::move(msg)]() mutable {
    process(std::move(msg));  // æ­£ç¡®çš„ move è¯­ä¹‰
});
```

#### 3. æ·»åŠ æ€§èƒ½æŒ‡å—

**async_waitgroup.hpp**ï¼š
```cpp
/**
 * æ€§èƒ½å»ºè®®ï¼š
 * - æ¯æ¬¡è°ƒç”¨ add() éƒ½ä¼š post ä¸€ä¸ªä»»åŠ¡åˆ° strand
 * - å¦‚æœè¦å¯åŠ¨ N ä¸ªä»»åŠ¡ï¼Œä½¿ç”¨ add(N) æ¯”è°ƒç”¨ N æ¬¡ add(1) æ›´é«˜æ•ˆ
 * - æ‰¹é‡æ“ä½œå¯ä»¥å‡å°‘ post å¼€é”€å’Œ lambda å¯¹è±¡åˆ›å»º
 */
```

**dispatcher.hpp**ï¼š
```cpp
/**
 * æ€§èƒ½æ³¨æ„äº‹é¡¹ï¼š
 * - æ¶ˆæ¯ä¼šè¢«å¤åˆ¶ç»™æ¯ä¸ªè®¢é˜…è€…ï¼ˆå¯¹äºå°æ¶ˆæ¯é€šå¸¸å¾ˆå¿«ï¼‰
 * - å¯¹äºå¤§æ¶ˆæ¯ï¼ˆå¦‚å¤§bufferï¼‰ï¼Œå»ºè®®å°†æ¶ˆæ¯ç±»å‹å®šä¹‰ä¸º shared_ptr<LargeData>
 * - è¿™æ ·åªä¼šå¤åˆ¶æŒ‡é’ˆï¼Œé¿å…æ·±æ‹·è´
 * - ä¸¤çº§å¼‚æ­¥åˆ†å‘ï¼ˆdispatcher strand + å„é˜Ÿåˆ—strandï¼‰
 * - é«˜åååœºæ™¯å»ºè®®ä½¿ç”¨æ‰¹é‡æ“ä½œ
 */
```

**async_semaphore.hpp**ï¼š
```cpp
/**
 * ä½¿ç”¨åœºæ™¯ï¼šå½“ semaphore ç‹¬ç«‹ä½¿ç”¨æ—¶
 * vs
 * ä½¿ç”¨åœºæ™¯ï¼šå½“ semaphore ä¸å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ async_queueï¼‰å…±äº« strand æ—¶
 */
```

---

## æ€»ç»“

### å…³é”®æ”¹è¿›ç‚¹

1. **è®¾è®¡ç®€åŒ–**
   - ç§»é™¤ atomic + strand æ··ç”¨æ¨¡å¼
   - ç»Ÿä¸€ä½¿ç”¨ strand è¿›è¡ŒåŒæ­¥
   - åˆ é™¤éæ ¸å¿ƒåŠŸèƒ½ï¼ˆreset, closeï¼‰

2. **æ€§èƒ½ä¼˜åŒ–**
   - å…±äº« strand æ¶ˆé™¤è·¨ strand å¼€é”€
   - æ‰¹é‡æ“ä½œå‡å°‘è°ƒåº¦å¼€é”€
   - æ–‡æ¡£æŒ‡å¯¼ç”¨æˆ·è¿›è¡Œæ€§èƒ½ä¼˜åŒ–

3. **ä»£ç è´¨é‡**
   - æ˜¾å¼åˆ é™¤æ‹·è´/ç§»åŠ¨æ„é€ 
   - æˆå‘˜å£°æ˜é¡ºåºä¸€è‡´
   - ç¤ºä¾‹ä»£ç éµå¾ªæœ€ä½³å®è·µ

4. **æ–‡æ¡£å®Œå–„**
   - æ˜ç¡®è®¾è®¡å†³ç­–çš„ç†ç”±
   - è­¦å‘Šæ‰§è¡Œä¸Šä¸‹æ–‡é—®é¢˜
   - æä¾›æ€§èƒ½æŒ‡å—

### Atomic ä½¿ç”¨åŸåˆ™

ç»è¿‡å®¡æŸ¥ç¡®ç«‹çš„æ˜ç¡®è§„åˆ™ï¼š
- âœ… **å…è®¸ä½¿ç”¨**ï¼šéœ€è¦åœ¨ strand å¤–ç«‹å³è¿”å›çš„å€¼ï¼ˆå¦‚ ID ç”Ÿæˆï¼‰
- âŒ **ä¸å…è®¸ä½¿ç”¨**ï¼šå¯ä»¥åœ¨ strand å†…è®¿é—®çš„å…±äº«çŠ¶æ€
- ğŸ“ **å¿…é¡»æ–‡æ¡£åŒ–**ï¼šæ¯ä¸ª atomic å˜é‡éƒ½å¿…é¡»æ³¨é‡Šè¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦å®ƒ

### æ€§èƒ½æƒè¡¡

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | ä½¿ç”¨åœºæ™¯ |
|------|------|------|----------|
| å…±äº« strand | ä½å»¶è¿Ÿï¼Œé«˜åå | handler åœ¨å†…éƒ¨ executor æ‰§è¡Œ | async_queue |
| ç‹¬ç«‹ strand | æ¨¡å—ç‹¬ç«‹ï¼Œexecutor éš”ç¦» | è·¨ strand å¼€é”€ | é€šç”¨ç»„ä»¶ |
| æ‰¹é‡æ“ä½œ | å‡å°‘è°ƒåº¦å¼€é”€ | API å¤æ‚åº¦å¢åŠ  | é«˜åååœºæ™¯ |

### æœ€ç»ˆçŠ¶æ€

æ‰€æœ‰ä»£ç ï¼š
- âœ… æ—  linter é”™è¯¯
- âœ… è®¾è®¡ä¸€è‡´æ€§
- âœ… æ–‡æ¡£å®Œå–„
- âœ… æ€§èƒ½ä¼˜åŒ–
- âœ… æœ€ä½³å®è·µ

